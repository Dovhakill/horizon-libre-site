{% extends "base.html.j2" %}
{% block title %}Accueil - Horizon Libre{% endblock %}
{% block content %}
<main class="container mx-auto px-6 py-10" id="content">
    <h2 class="text-3xl font-bold mb-8 border-l-4 border-blue-800 pl-4">Nos derniers articles</h2>
    <div id="articles-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
        </div>
    <p id="loading-message">Chargement des articles...</p>
</main>

<script>
    // --- SCRIPT DE CHARGEMENT FINAL ET SÉCURISÉ ---

    async function loadArticles() {
        const articlesGrid = document.getElementById('articles-grid');
        const loadingMessage = document.getElementById('loading-message');
        const repoName = 'Dovhakill/horizon-libre-site';

        // On lit le token depuis la balise meta sécurisée
        const tokenMeta = document.querySelector('meta[name="github-token"]');
        const GITHUB_TOKEN = tokenMeta ? tokenMeta.getAttribute('content') : null;

        if (!GITHUB_TOKEN) {
            loadingMessage.textContent = "Erreur de configuration : Token manquant.";
            return;
        }

        try {
            const response = await fetch(`https://api.github.com/repos/${repoName}/contents/articles`, {
                headers: { 'Authorization': `token ${GITHUB_TOKEN}` }
            });

            if (!response.ok) throw new Error(`Erreur GitHub API: ${response.statusText}`);

            const files = await response.json();
            const sortedFiles = files
                .filter(file => file.name.endsWith('.html'))
                .sort((a, b) => b.name.localeCompare(a.name))
                .slice(0, 9); // On affiche 9 articles

            if (sortedFiles.length === 0) {
                loadingMessage.textContent = 'Aucun article à afficher pour le moment.';
                return;
            }

            loadingMessage.style.display = 'none';

            for (const file of sortedFiles) {
                const articleCard = document.createElement('div');
                articleCard.className = 'bg-white rounded-lg shadow-md overflow-hidden';
                const title = file.name.replace('.html', '').substring(20).replace(/-/g, ' ');

                articleCard.innerHTML = `
                    <a href="/articles/${file.name}">
                        <div class="h-48 bg-gray-200 flex items-center justify-center text-gray-500">
                            <span class="text-xs text-gray-400">Image à venir</span>
                        </div>
                    </a>
                    <div class="p-6">
                        <h3 class="font-bold text-xl capitalize">${title}</h3>
                        <a href="/articles/${file.name}" class="text-sm font-semibold text-blue-800 hover:underline mt-4 inline-block">Lire la suite</a>
                    </div>
                `;
                articlesGrid.appendChild(articleCard);
            }

        } catch (error) {
            console.error('Erreur:', error);
            loadingMessage.textContent = `Impossible de charger les articles. Erreur: ${error.message}`;
        }
    }

    document.addEventListener('DOMContentLoaded', loadArticles);
</script>
{% endblock %}
